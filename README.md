# Lo2IoTHub

Spring Boot project reading events from Live Objects MQTT and pushing them to Azure IoT Hub, registering devices in IoT Hub previously registered in Live Objects and receiving commands from IoT Hub and sending them to the devices via Live Objects API.

## Introduction

This project is intended for Live Objects users wishing to explore integration patterns with Azure and for organizations already running business logic on Azure planning to work on events from IoT devices sourced via Live Objects.

## Requirements

It is assumed that the reader of this document is familiar with Live Objects and Azure. In order to run the connector, it is required to have access to: a Live Objects account with MQTT fifo queue API key which can access the queue (API key generation is described in the [user guide](https://liveobjects.orange-business.com/cms/app/uploads/EN_User-guide-Live-Objects-4.pdf)), 
an Azure account IoT Hub set up (creation process is described in official [documentation](https://docs.microsoft.com/en-us/azure/iot-hub/). Access key to IoT HuB (it is automatically generated by Azure Azure CLI (see [documentation](https://docs.microsoft.com/en-us/cli/azure/?view=azure-cli-latest)), Application Insights resource (creation process is described in official [documentation](https://docs.microsoft.com/pl-pl/azure/azure-monitor/app/create-new-resource)). Apache Maven and Git client is neccessary.

## Connector

The connector (Lo2IoTHub) subscribes to selected Live Objects MQTT queue, reads all events and publishes them to selected IoT Hub device without any modification to events’ contents. Registers all the Live Objects devices in IoT HuB and receives commands from IoT Hub to send them to Live Objects device. It is intended to be run as a long-running process hosted on Azure. Connector code is written in Java, using the Spring Boot framework. 
 
### Performance & scalability

The software is an open source toolbox which has to be integrated into an end to end solution. The ordering of messages is not guaranteed to be preserved; the application uses thread pools to run its MQTT and IoT Hub adapters which may cause some messages to arrive in IoT Hub out of order in which they were kept within Live Objects’ MQTT queue.
Live Objects platform supports load balancing between multiple MQTT subscribers.

### Installation

In order to be deployed to Azure, the project uses Azure Webapp Maven Plugin. The installation description is based on the following [documentation](https://docs.microsoft.com/en-us/java/azure/spring-framework/deploy-spring-boot-java-app-with-maven-plugin).

### App Service Plan creation

Application requires an [see](https://docs.microsoft.com/en-us/azure/app-service/overview-hosting-plans) to run on Azure. App Service Plan defines compute resources available for the application during execution, exposing a runtime platform (Platform as a Service). It is a paid service, the price depending on CPU and RAM configuration.
To create a Plan, enter (https://portal.azure.com/) and select “create a resource” option. In the search field type “App Service Plan”, click “Create”. Now you need to provide a name, operating system (connector was tested on Linux, but it should work without problems on Windows as well), location, resource group and the size. Afterwards, click “Review and create”, then final “Create”.

### Application deployment

Deployment to Azure is performed by the Azure Webapp Maven Plugin. Its configuration is included in `pom.xml` file within the connector project.
The following lines are relevant:
```
<resourceGroup>JavaApps</resourceGroup>
<appServicePlanName>PremiumPlan</appServicePlanName>
<appName>lo2iothub</appName>
```
The `resourceGroup` and `appServicePlanName` should correspond to values provided during App Service Plan creation. Application name will be used to uniquely identify the deployed connector app.

**Azure login**

In order to deploy the application, the prerequisite is to have a logged session to Azure. Run the following command using Azure CLI tool:
```
az login
```
Follow the instructions to complete the login process. 

**JAR deployment**

Build the JAR file using command:
```
mvn clean package
```
Deploy the application with the command:
```
mvn azure-webapp:deploy
```

If you repeat those steps, application will be redeployed, replacing the previously-deployed instance on Azure. Please keep in mind that you don’t have to repeat the login to Azure (unless the session expired, which will result in appropriate error message during app deployment).

### Configuration

Application is using standard Spring mechanisms for configuration, with all properties stored within `application.yml` file. Properties values can be kept there and/or overridden from other sources (e.g. from environment variables) – see more information in [documentation](https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-external-config.html). The following properties are used for integration:
##### lo.uri
URI of the Live Objects platform.
Default value `ssl://liveobjects.orange-business.com:8883`
##### lo.api-key
API key to authorize the MQTT connector. Information on how to create a Live Objects API key can be found in (https://liveobjects.orange-business.com/doc/html/lo_manual.html#API_KEY). 
There is no sensible default value since it should correspond to your account on Live Objects.
##### lo.topic
Name of the MQTT queue. For example, if Live Objects web portal displays a FIFO named “dev” (seen under “Data -> FIFO” option), to subscribe to this queue the property should be set to `fifo/dev`.
##### azure.iot-host-name
Name of IoT Hub to which the MQTT messages should be written to.
##### azure.iot-connection-string
Connection string with host name, shared access key name and shared access key to be used in communication with IoT Hub.
##### tagPlatformKey
Tag name for platform (i. e. platform).
##### tagPlatformValue
Tag platform value (i. e. LiveObjects).